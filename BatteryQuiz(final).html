<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈõªË∑ØÂØ¶È©óÂÆ§ - ‰∏≤ËÅØËàá‰∏¶ËÅØ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes pulse-slow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        body { margin: 0; overflow: hidden; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- SVG Icons Components ---
        const IconBattery = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="10" x="2" y="7" rx="2" ry="2"/><line x1="22" x2="22" y1="11" y2="13"/></svg>;
        const IconLightbulb = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A5 5 0 0 0 8 8c0 1.3.5 2.6 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>;
        const IconZap = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
        const IconRotate = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const IconPencil = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>;
        const IconMove = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/></svg>;
        const IconEraser = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21Z"/><path d="m22 21H7"/><path d="m5 11 9 9"/></svg>;
        const IconArrowRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>;
        const IconTrophy = ({ size = 24, className }) => <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
        const IconStar = ({ size = 24, className, style }) => <svg style={style} className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>;
        const IconSparkles = ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>;

        const App = () => {
            const [items, setItems] = useState([]);
            const [connections, setConnections] = useState([]);
            const [score, setScore] = useState(null); 
            const [errorDetails, setErrorDetails] = useState([]);
            const [isEvaluating, setIsEvaluating] = useState(false);
            const [showLight, setShowLight] = useState(false);
            const [toolMode, setToolMode] = useState('move'); 
            const [currentChallengeIdx, setCurrentChallengeIdx] = useState(0);
            const [hasFinishedCurrent, setHasFinishedCurrent] = useState(false);
            const [showFinalCertificate, setShowFinalCertificate] = useState(false);
            
            const [interactionMode, setInteractionMode] = useState(null); 
            const [activeId, setActiveId] = useState(null);
            const [currentPath, setCurrentPath] = useState([]);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            
            const svgRef = useRef(null);

            const challenges = [
                {
                    id: 'series',
                    title: "Á¨¨‰∏ÄÈóúÔºöÁáàÊ≥°‰∏≤ËÅØ",
                    instruction: (
                        <span>‰ªªÂãôÔºöÁµÑÂá∫‰∏ÄÂÄã 2 ÂÄã<span className="text-emerald-600">ÁáàÊ≥°‰∏≤ËÅØ</span> 1 È°ÜÈõªÊ±†ÁöÑÈõªË∑Ø</span>
                    ),
                    targetBulbs: 2,
                    targetBatteries: 1,
                    type: 'series'
                },
                {
                    id: 'parallel',
                    title: "Á¨¨‰∫åÈóúÔºöÁáàÊ≥°‰∏¶ËÅØ",
                    instruction: (
                        <span>‰ªªÂãôÔºöÁµÑÂá∫‰∏ÄÂÄã 2 ÂÄã<span className="text-orange-500">ÁáàÊ≥°‰∏¶ËÅØ</span> 1 È°ÜÈõªÊ±†ÁöÑÈõªË∑Ø</span>
                    ),
                    targetBulbs: 2,
                    targetBatteries: 1,
                    type: 'parallel'
                }
            ];

            const challenge = challenges[currentChallengeIdx];

            const addItem = (type) => {
                if (hasFinishedCurrent) return;
                setShowLight(false);
                setScore(null);
                const newItem = {
                    id: Math.random().toString(36).substr(2, 9),
                    type,
                    x: 150 + Math.random() * 100,
                    y: 150 + Math.random() * 100,
                    width: type === 'battery' ? 180 : 100,
                    height: type === 'battery' ? 80 : 155,
                    ports: type === 'battery' 
                        ? [
                                { id: 'neg', offset: { x: 10, y: 40 }, radius: 30 }, 
                                { id: 'pos', offset: { x: 170, y: 40 }, radius: 30 } 
                            ]
                        : [
                                { id: 'side', offset: { x: 50, y: 110 }, radius: 24 }, 
                                { id: 'bottom', offset: { x: 50, y: 150}, radius: 32 } 
                            ]
                };
                setItems(prev => [...prev, newItem]);
            };

            const getSVGCoords = (e) => {
                const svg = svgRef.current;
                if (!svg) return { x: 0, y: 0 };
                const rect = svg.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const getPortAt = (coords) => {
                for (const item of items) {
                    for (const port of item.ports) {
                        const px = item.x + port.offset.x;
                        const py = item.y + port.offset.y;
                        const dist = Math.sqrt((px - coords.x) ** 2 + (py - coords.y) ** 2);
                        if (dist < port.radius) return { itemId: item.id, portId: port.id };
                    }
                }
                return null;
            };

            const handleStart = (e) => {
                if (isEvaluating || hasFinishedCurrent) return;
                const coords = getSVGCoords(e);
                if (toolMode === 'eraser') {
                    setConnections(prev => prev.filter(conn => 
                        !conn.pathPoints.some(p => Math.sqrt((p.x - coords.x)**2 + (p.y - coords.y)**2) < 15)
                    ));
                    return;
                }
                const clickedItem = [...items].reverse().find(item => 
                    coords.x >= item.x && coords.x <= item.x + item.width &&
                    coords.y >= item.y && coords.y <= item.y + item.height
                );
                if (toolMode === 'move' && clickedItem) {
                    setInteractionMode('dragging');
                    setActiveId(clickedItem.id);
                    setDragOffset({ x: coords.x - clickedItem.x, y: coords.y - clickedItem.y });
                } else if (toolMode === 'pencil') {
                    setInteractionMode('drawing');
                    setCurrentPath([coords]);
                }
            };

            const handleMove = (e) => {
                if (!interactionMode) return;
                const coords = getSVGCoords(e);
                if (interactionMode === 'drawing') {
                    setCurrentPath(prev => [...prev, coords]);
                } else if (interactionMode === 'dragging') {
                    setItems(prev => prev.map(item => 
                        item.id === activeId ? { ...item, x: coords.x - dragOffset.x, y: coords.y - dragOffset.y } : item
                    ));
                }
            };

            const handleEnd = () => {
                if (interactionMode === 'drawing' && currentPath.length > 2) {
                    const startPort = getPortAt(currentPath[0]);
                    const endPort = getPortAt(currentPath[currentPath.length - 1]);
                    if (startPort || endPort) {
                        setConnections(prev => [...prev, {
                            id: `c-${Date.now()}`,
                            from: startPort,
                            to: endPort,
                            pathPoints: currentPath
                        }]);
                    }
                }
                setInteractionMode(null); setActiveId(null); setCurrentPath([]);
            };

            const evaluateCircuit = () => {
                setIsEvaluating(true);
                const errors = [];
                
                setTimeout(() => {
                    const bulbs = items.filter(i => i.type === 'bulb');
                    const batteries = items.filter(i => i.type === 'battery');
                    
                    if (batteries.length !== challenge.targetBatteries) {
                        errors.push(`ÈõªÊ±†Êï∏ÈáèÊáâÁÇ∫ ${challenge.targetBatteries} ÂÄã`);
                    }
                    if (bulbs.length !== challenge.targetBulbs) {
                        errors.push(`ÁáàÊ≥°Êï∏ÈáèÊáâÁÇ∫ ${challenge.targetBulbs} ÂÄã`);
                    }

                    if (errors.length > 0) {
                        setScore('wrong');
                        setErrorDetails(errors);
                        setIsEvaluating(false);
                        return;
                    }

                    const battery = batteries[0];
                    const batteryPos = `${battery.id}-pos`;
                    const batteryNeg = `${battery.id}-neg`;

                    const wireAdj = new Map();
                    const addWireEdge = (u, v) => {
                        if (!wireAdj.has(u)) wireAdj.set(u, []);
                        if (!wireAdj.has(v)) wireAdj.set(v, []);
                        wireAdj.get(u).push(v);
                        wireAdj.get(v).push(u);
                    };

                    connections.forEach(c => {
                        if (c.from && c.to) {
                            addWireEdge(`${c.from.itemId}-${c.from.portId}`, `${c.to.itemId}-${c.to.portId}`);
                        }
                    });

                    const isConnectedByWire = (start, target) => {
                        if (start === target) return true;
                        const visited = new Set();
                        const queue = [start];
                        while(queue.length > 0) {
                            const curr = queue.shift();
                            if (curr === target) return true;
                            visited.add(curr);
                            (wireAdj.get(curr) || []).forEach(next => {
                                if (!visited.has(next)) queue.push(next);
                            });
                        }
                        return false;
                    };

                    if (isConnectedByWire(batteryPos, batteryNeg)) {
                        errors.push("Ë≠¶ÂëäÔºöÈõªË∑ØÁôºÁîüÁü≠Ë∑ØÔºÅÂ∞éÁ∑öÁõ¥Êé•ÈÄ£Êé•‰∫ÜÈõªÊ±†ÁöÑÊ≠£Ë≤†Ê•µ„ÄÇ");
                    }

                    const fullAdj = new Map();
                    const addEdge = (u, v) => {
                        if (!fullAdj.has(u)) fullAdj.set(u, []);
                        if (!fullAdj.has(v)) fullAdj.set(v, []);
                        fullAdj.get(u).push(v);
                        fullAdj.get(v).push(u);
                    };

                    bulbs.forEach(b => {
                        addEdge(`${b.id}-side`, `${b.id}-bottom`);
                    });

                    connections.forEach(c => {
                        if (c.from && c.to) {
                            addEdge(`${c.from.itemId}-${c.from.portId}`, `${c.to.itemId}-${c.to.portId}`);
                        }
                    });

                    if (challenge.type === 'series') {
                        const findSeriesLoop = (curr, target, visited, bulbsCrossed) => {
                            if (curr === target && bulbsCrossed.size === bulbs.length) return true;
                            visited.add(curr);
                            const neighbors = fullAdj.get(curr) || [];
                            for (const next of neighbors) {
                                const newBulbsCrossed = new Set(bulbsCrossed);
                                bulbs.forEach(b => {
                                    const isCrossing = (curr === `${b.id}-side` && next === `${b.id}-bottom`) || 
                                                                     (curr === `${b.id}-bottom` && next === `${b.id}-side`);
                                    if (isCrossing) newBulbsCrossed.add(b.id);
                                });
                                if (!visited.has(next) || (next === target && visited.size > 2)) {
                                    if (findSeriesLoop(next, target, new Set(visited), newBulbsCrossed)) return true;
                                }
                            }
                            return false;
                        };

                        if (!findSeriesLoop(batteryPos, batteryNeg, new Set(), new Set())) {
                            const connectionErrors = [];
                            bulbs.forEach((b, i) => {
                                const hasSide = connections.some(c => (c.from?.itemId === b.id && c.from?.portId === 'side') || (c.to?.itemId === b.id && c.to?.portId === 'side'));
                                const hasBottom = connections.some(c => (c.from?.itemId === b.id && c.from?.portId === 'bottom') || (c.to?.itemId === b.id && c.to?.portId === 'bottom'));
                                if (!hasSide || !hasBottom) {
                                    connectionErrors.push(`ÁáàÊ≥° ${i+1} ÂøÖÈ†àÂêåÊôÇÈÄ£Êé•„ÄåÂÅ¥ÈÇäÈáëÂ±¨„ÄçËàá„ÄåÂ∫ïÈÉ®Êé•Èªû„Äç„ÄÇ`);
                                }
                            });
                            if (connectionErrors.length > 0) errors.push(...connectionErrors);
                            else errors.push("Êú™ÂΩ¢ÊàêÊ≠£Á¢∫ÁöÑ‰∏≤ËÅØËø¥Ë∑Ø„ÄÇ");
                        }
                    } else {
                        let activeBulbCount = 0;
                        bulbs.forEach((b, idx) => {
                            const side = `${b.id}-side`;
                            const bottom = `${b.id}-bottom`;
                            const sideToPos = isConnectedByWire(side, batteryPos);
                            const sideToNeg = isConnectedByWire(side, batteryNeg);
                            const bottomToPos = isConnectedByWire(bottom, batteryPos);
                            const bottomToNeg = isConnectedByWire(bottom, batteryNeg);
                            
                            if ((sideToPos && bottomToNeg) || (sideToNeg && bottomToPos)) {
                                activeBulbCount++;
                            } else {
                                errors.push(`ÁáàÊ≥° ${idx + 1} Êú™Ê≠£Á¢∫ÈÄ£ÈÄöÔºàÈúÄÂêåÊôÇÈÄ£Êé•ÂÅ¥ÈÇäËàáÂ∫ïÈÉ®‰∏¶ÈÄöÂæÄÈõªÊ±†ÂÖ©Ê•µÔºâ„ÄÇ`);
                            }
                        });

                        if (activeBulbCount !== bulbs.length) {
                            errors.push("‰∏¶ËÅØ‰ªªÂãôÂ§±ÊïóÔºö‰∏¶ÈùûÊâÄÊúâÁáàÊ≥°ÈÉΩÂΩ¢Êàê‰∫ÜÁç®Á´ãÈÄöË∑Ø„ÄÇ");
                        }
                    }

                    if (errors.length === 0) {
                        setScore('correct');
                        setShowLight(true);
                        setHasFinishedCurrent(true);
                    } else {
                        setScore('wrong');
                        setShowLight(false);
                        setErrorDetails([...new Set(errors)]);
                    }
                    setIsEvaluating(false);
                }, 800);
            };

            const handleScoreConfirm = () => {
                setScore(null);
                if (currentChallengeIdx === 1 && hasFinishedCurrent) {
                    setTimeout(() => {
                        setShowFinalCertificate(true);
                    }, 500); 
                }
            };

            const goToNextChallenge = () => {
                setItems([]); setConnections([]); setScore(null); setShowLight(false); setErrorDetails([]);
                setHasFinishedCurrent(false);
                setCurrentChallengeIdx(prev => prev + 1);
            };

            const resetCurrentChallenge = () => {
                setItems([]); setConnections([]); setScore(null); setShowLight(false); setErrorDetails([]);
                setHasFinishedCurrent(false);
                setShowFinalCertificate(false);
            };

            return (
                <div className="flex flex-col h-screen bg-slate-50 font-sans text-slate-800 select-none overflow-hidden relative">
                    <header className="bg-white border-b border-emerald-100 px-8 py-4 flex justify-between items-center shadow-sm z-30">
                        <div className="flex items-center gap-6">
                            <div className="flex items-center">
                                 <div className={`p-2 rounded-lg ${showLight ? "bg-yellow-100" : "bg-emerald-50"}`}>
                                     <IconZap className={showLight ? "text-yellow-600 fill-yellow-500" : "text-emerald-400"} />
                                 </div>
                                 <div className="w-px h-8 bg-emerald-100 mx-4" />
                            </div>
                            <div className="flex flex-col">
                                <span className="text-[10px] font-black text-emerald-600 uppercase tracking-widest mb-0.5">{challenge.title}</span>
                                <div className="text-slate-900 font-extrabold text-xl tracking-tight">{challenge.instruction}</div>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={resetCurrentChallenge} className="p-2.5 text-slate-400 hover:text-red-500 transition-all bg-white rounded-xl border border-slate-200 hover:border-red-200">
                                <IconRotate />
                            </button>
                            <button onClick={evaluateCircuit} disabled={isEvaluating || hasFinishedCurrent} className="px-8 py-2.5 bg-emerald-600 text-white rounded-xl font-black shadow-md hover:bg-emerald-700 active:scale-95 transition-all disabled:opacity-50">
                                {isEvaluating ? "ÂàÜÊûê‰∏≠..." : "Êèê‰∫§Á≠îÊ°à"}
                            </button>
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        <aside className="w-24 border-r border-emerald-50 flex flex-col items-center py-8 gap-8 bg-white shadow-sm">
                            <button onClick={() => addItem('battery')} disabled={hasFinishedCurrent} className="flex flex-col items-center gap-2 group disabled:opacity-30">
                                <div className="w-16 h-16 rounded-2xl border-2 border-slate-100 flex items-center justify-center bg-slate-50 group-hover:border-emerald-500 group-hover:bg-emerald-50 transition-all">
                                    <div className="text-slate-600 group-hover:text-emerald-600"><IconBattery /></div>
                                </div>
                                <span className="text-[11px] font-black text-slate-400 uppercase tracking-tighter">ÈõªÊ±†</span>
                            </button>
                            <button onClick={() => addItem('bulb')} disabled={hasFinishedCurrent} className="flex flex-col items-center gap-2 group disabled:opacity-30">
                                <div className="w-16 h-16 rounded-2xl border-2 border-slate-100 flex items-center justify-center bg-slate-50 group-hover:border-emerald-500 group-hover:bg-emerald-50 transition-all">
                                    <div className="text-slate-600 group-hover:text-emerald-600"><IconLightbulb /></div>
                                </div>
                                <span className="text-[11px] font-black text-slate-400 uppercase tracking-tighter">ÁáàÊ≥°</span>
                            </button>
                            <div className="w-10 h-px bg-slate-100" />
                            <div className="flex flex-col gap-4">
                                <button onClick={() => setToolMode('move')} className={`p-3.5 rounded-xl transition-all ${toolMode === 'move' ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400 hover:bg-emerald-50 hover:text-emerald-600'}`}><IconMove /></button>
                                <button onClick={() => setToolMode('pencil')} className={`p-3.5 rounded-xl transition-all ${toolMode === 'pencil' ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400 hover:bg-emerald-50 hover:text-emerald-600'}`}><IconPencil /></button>
                                <button onClick={() => setToolMode('eraser')} className={`p-3.5 rounded-xl transition-all ${toolMode === 'eraser' ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400 hover:bg-emerald-50 hover:text-emerald-600'}`}><IconEraser /></button>
                            </div>
                        </aside>

                        <main className="flex-1 relative bg-white touch-none overflow-hidden" onMouseDown={handleStart} onMouseMove={handleMove} onMouseUp={handleEnd} onTouchStart={handleStart} onTouchMove={handleMove} onTouchEnd={handleEnd}>
                            <div className="absolute inset-0 pointer-events-none" style={{ backgroundImage: `linear-gradient(to right, #ecfdf5 1px, transparent 1px), linear-gradient(to bottom, #ecfdf5 1px, transparent 1px)`, backgroundSize: '20px 20px' }} />
                            
                            <svg ref={svgRef} className="absolute inset-0 w-full h-full pointer-events-none z-10">
                                {connections.map(conn => (
                                    <polyline key={conn.id} points={conn.pathPoints.map(p => `${p.x},${p.y}`).join(' ')} fill="none" stroke={showLight ? "#fbbf24" : "#475569"} strokeWidth="5" strokeLinecap="round" strokeLinejoin="round" className="transition-colors duration-700 drop-shadow-sm" />
                                ))}
                                {interactionMode === 'drawing' && <polyline points={currentPath.map(p => `${p.x},${p.y}`).join(' ')} fill="none" stroke="#10b981" strokeWidth="3" strokeDasharray="6,6" opacity="0.5" />}
                            </svg>

                            {items.map(item => (
                                <div key={item.id} style={{ left: item.x, top: item.y, width: item.width, height: item.height }} className="absolute flex items-center justify-center group hover:z-20 transition-transform">
                                    {toolMode === 'move' && !hasFinishedCurrent && (
                                        <button onClick={() => setItems(prev => prev.filter(i => i.id !== item.id))} className="absolute -top-3 -right-3 w-8 h-8 bg-white border border-red-100 text-red-500 rounded-full flex items-center justify-center shadow-md z-30 opacity-0 group-hover:opacity-100 hover:bg-red-500 hover:text-white transition-all transform hover:scale-110">
                                            <IconTrash />
                                        </button>
                                    )}
                                    {item.type === 'battery' ? (
                                        <div className="relative pointer-events-none drop-shadow-md">
                                            <svg width="180" height="80" viewBox="0 0 180 80">
                                                <rect x="10" y="10" width="155" height="60" rx="6" fill="#1e293b" />
                                                <rect x="165" y="25" width="8" height="30" rx="2" fill="#94a3b8" />
                                                <rect x="145" y="10" width="15" height="60" fill="#facc15" fillOpacity="0.8" />
                                                <text x="35" y="48" fill="#ef4444" fontSize="32" fontWeight="900" textAnchor="middle">-</text>
                                                <text x="130" y="47" fill="#facc15" fontSize="24" fontWeight="900" textAnchor="middle">+</text>
                                            </svg>
                                        </div>
                                    ) : (
                                        <div className="relative pointer-events-none">
                                            {showLight && (
                                                <div className="absolute top-[5%] left-[-20%] w-[140%] h-[90%] z-0">
                                                    <div className="absolute inset-0 bg-yellow-400 blur-[35px] opacity-30 animate-pulse-slow rounded-full" />
                                                    <div className="absolute inset-4 bg-yellow-300 blur-[20px] opacity-50 rounded-full" />
                                                    <div className="absolute inset-8 bg-yellow-100 blur-[10px] opacity-70 rounded-full" />
                                                </div>
                                            )}
                                            <svg width="100" height="155" viewBox="0 0 100 155" className="relative z-10 drop-shadow-md">
                                                <defs>
                                                    <radialGradient id="bulbGlass" cx="50%" cy="40%" r="50%">
                                                        <stop offset="0%" stopColor={showLight ? "#FFFDE7" : "#FFFFFF"} stopOpacity="0.9" />
                                                        <stop offset="100%" stopColor={showLight ? "#FFF9C4" : "#F1F5F9"} stopOpacity="0.6" />
                                                    </radialGradient>
                                                </defs>
                                                <path d="M 20 55 A 30 30 0 1 1 80 55 Q 80 85 68 95 L 32 95 Q 20 85 20 55" fill="url(#bulbGlass)" stroke={showLight ? "#FACC15" : "#E2E8F0"} strokeWidth="1.5" />
                                                <path d="M 35 32 Q 40 22 55 22" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" opacity={showLight ? "0.9" : "0.5"} />
                                                <g opacity={showLight ? "1" : "0.4"}>
                                                    <line x1="42" y1="95" x2="42" y2="75" stroke={showLight ? "#B45309" : "#94A3B8"} strokeWidth="1" />
                                                    <line x1="58" y1="95" x2="58" y2="75" stroke={showLight ? "#B45309" : "#94A3B8"} strokeWidth="1" />
                                                    <path d="M 42 75 C 42 65, 58 65, 58 75 M 42 77 C 42 67, 58 67, 58 77" fill="none" stroke={showLight ? "#F59E0B" : "#64748B"} strokeWidth="1.5" strokeLinecap="round" className={showLight ? "animate-pulse" : ""} />
                                                    {showLight && <circle cx="50" cy="70" r="4" fill="#FEF9C3" filter="blur(2px)" />}
                                                </g>
                                                <rect x="32" y="95" width="36" height="32" rx="2" fill="#94A3B8" />
                                                <g stroke="#64748B" strokeWidth="1">
                                                    <line x1="32" y1="102" x2="68" y2="102" />
                                                    <line x1="32" y1="110" x2="68" y2="110" />
                                                    <line x1="32" y1="118" x2="68" y2="118" />
                                                </g>
                                                <path d="M 38 127 L 62 127 Q 62 145 50 145 Q 38 145 38 127 Z" fill="#1E293B" />
                                                <circle cx="50" cy="140" r="7" fill="#475569" stroke="#334155" strokeWidth="0.5" />
                                            </svg>
                                        </div>
                                    )}
                                </div>
                            ))}

                            {hasFinishedCurrent && currentChallengeIdx < challenges.length - 1 && (
                                <div className="absolute bottom-10 right-10 z-40">
                                    <button onClick={goToNextChallenge} className="px-10 py-5 bg-emerald-600 text-white rounded-2xl font-black shadow-xl hover:bg-emerald-700 transition-all flex items-center gap-4 group hover:-translate-y-1">
                                        <span className="text-lg">ÊåëÊà∞‰∏ã‰∏ÄÈóú</span> <div className="group-hover:translate-x-2 transition-transform"><IconArrowRight /></div>
                                    </button>
                                </div>
                            )}
                        </main>
                    </div>

                    {score && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-6">
                            <div className="bg-white p-10 rounded-[32px] shadow-2xl max-w-sm w-full text-center border border-emerald-50 animate-in zoom-in duration-300">
                                {score === 'correct' ? (
                                    <>
                                        <div className="w-20 h-20 bg-emerald-50 rounded-full flex items-center justify-center mx-auto mb-6"><IconTrophy size={48} className="text-emerald-600 animate-bounce"/></div>
                                        <h2 className="text-3xl font-black text-slate-900">Â§™Ê£í‰∫ÜÔºÅ</h2>
                                        <p className="text-slate-500 mt-3 font-medium">ÈõªË∑ØÈÄ£Êé•Ê≠£Á¢∫„ÄÇüí°</p>
                                        <button onClick={handleScoreConfirm} className="mt-8 w-full py-4 bg-emerald-600 text-white rounded-2xl font-black shadow-lg hover:bg-emerald-700 transition-colors">Êü•ÁúãÁµêÊûú</button>
                                    </>
                                ) : (
                                    <>
                                        <div className="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6"><div className="text-red-500"><IconAlert /></div></div>
                                        <h2 className="text-3xl font-black text-slate-900">ÈúÄË¶ÅË™øÊï¥</h2>
                                        <div className="text-slate-600 mt-4 text-sm space-y-3 text-left bg-slate-50 p-6 rounded-2xl border border-slate-100">
                                            <ul className="space-y-2">{errorDetails.map((err, i) => (<li key={i} className="flex gap-2 items-start font-semibold"><span className="mt-1.5 p-1 rounded-full bg-red-400 shrink-0" />{err}</li>))}</ul>
                                        </div>
                                        <button onClick={() => setScore(null)} className="mt-8 w-full py-4 bg-slate-800 text-white rounded-2xl font-black shadow-lg hover:bg-slate-900 transition-colors">ÈáçÊñ∞ÂòóË©¶</button>
                                    </>
                                )}
                            </div>
                        </div>
                    )}

                    {showFinalCertificate && (
                        <div className="fixed inset-0 bg-emerald-900/80 backdrop-blur-xl flex items-center justify-center z-[100] p-6 animate-in fade-in duration-700">
                            <div className="relative max-w-lg w-full">
                                <div className="bg-white rounded-[40px] shadow-[0_20px_50px_rgba(0,0,0,0.3)] overflow-hidden border-8 border-yellow-400 relative p-12 text-center animate-in zoom-in duration-500">
                                    <div className="absolute top-4 left-4 text-yellow-400 opacity-40"><IconSparkles size={40} /></div>
                                    <div className="relative mb-8">
                                        <div className="w-32 h-32 bg-gradient-to-tr from-yellow-400 via-yellow-200 to-yellow-500 rounded-full flex items-center justify-center mx-auto border-4 border-white shadow-xl relative z-10">
                                            <IconTrophy size={70} className="text-yellow-700 animate-pulse" />
                                        </div>
                                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 bg-yellow-200/30 rounded-full blur-3xl animate-pulse" />
                                    </div>
                                    
                                    <h1 className="text-5xl font-black bg-gradient-to-r from-emerald-600 via-blue-600 to-purple-600 bg-clip-text text-transparent mb-6 tracking-tight">
                                        ÊàêÂ∞±Ëß£ÈéñÔºÅ
                                    </h1>
                                    <p className="text-slate-600 font-bold text-xl mb-10 leading-relaxed">
                                        ÊÅ≠Âñú‰Ω†ÂÆåÊàêÊâÄÊúâ‰ªªÂãôÔºÅ<br/>
                                        ‰Ω†ÁèæÂú®Â∑≤Á∂ìÂ≠∏ÊúÉ‰∫ÜÁáàÊ≥°ÁöÑ‰∏≤ËÅØÂíå‰∏¶ËÅØ„ÄÇ
                                    </p>
                                    
                                    <div className="flex flex-col gap-4">
                                        <button 
                                            onClick={() => { setShowFinalCertificate(false); resetCurrentChallenge(); setCurrentChallengeIdx(0); }} 
                                            className="w-full py-5 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-3xl font-black text-2xl shadow-[0_10px_20px_rgba(16,185,129,0.3)] hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-3"
                                        >
                                            <IconRotate /> ÂÜçÊ¨°ÊåëÊà∞
                                        </button>
                                    </div>

                                    <div className="mt-8 flex justify-center gap-2">
                                        {[...Array(5)].map((_, i) => (
                                            <IconStar key={i} size={24} className="text-yellow-400 fill-yellow-400" style={{ animation: `spin ${3+i}s linear infinite` }} />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>